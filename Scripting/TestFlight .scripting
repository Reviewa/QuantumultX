// @ts-nocheck

import { fetch, Notification, Widget, Script, Navigation, NavigationStack, Text, VStack, Spacer, Link, Slider, Button, Toggle, useState, useEffect } from "scripting"

// ---------------- é…ç½® ----------------
const MIN_INTERVAL = 5
const MAX_DISPLAY = 5
const STORAGE_KEY = "_departures_lastTitle"
const INTERVAL_KEY = "_departures_interval"
const ENABLE_KEY = "_departures_enable"

// ---------------- æœ¬åœ°å­˜å‚¨ ----------------
function getStorage(key, defaultValue) {
  try { return globalThis._departuresStore?.[key] ?? defaultValue } catch { return defaultValue }
}
function setStorage(key, value) {
  globalThis._departuresStore = globalThis._departuresStore || {}
  globalThis._departuresStore[key] = value
}

// ---------------- è·å–æœ€æ–°æ¡ç›® ----------------
async function fetchDepartures() {
  try {
    const html = await fetch("https://departures.to/latest").then(r => r.text())
    const regex = /<h2[^>]*>.*?<a href="(.*?)".*?>(.*?)<\/a>.*?<\/h2>/g
    const items = []
    let match
    while ((match = regex.exec(html)) !== null) {
      const link = match[1].trim()
      const title = match[2].replace(/<[^>]+>/g, "").trim()
      if (title && link) items.push({ title, link })
    }
    return items
  } catch (e) {
    console.error("è·å– departures.to æ•°æ®å¤±è´¥:", e)
    return []
  }
}

// ---------------- å‘é€é€šçŸ¥ ----------------
async function notifyNew(item) {
  const lastTitle = getStorage(STORAGE_KEY, "")
  if (item.title !== lastTitle) {
    await Notification.schedule({ title: "Departures æ–°æ¡ç›®", body: item.title })
    setStorage(STORAGE_KEY, item.title)
  }
}

// ---------------- ä¸»ç•Œé¢ ----------------
function View() {
  const dismiss = Navigation.useDismiss()
  const [interval, setInterval] = useState(getStorage(INTERVAL_KEY, 60))
  const [enabled, setEnabled] = useState(getStorage(ENABLE_KEY, true))
  const [items, setItems] = useState([])

  async function refresh() {
    const data = await fetchDepartures()
    setItems(data)
    if (enabled && data.length > 0) await notifyNew(data[0])
  }

  useEffect(() => { refresh() }, [])

  const stack = new VStack()
  stack.spacing = 10
  stack.padding = 16
  stack.alignment = "leading"

  const titleText = new Text("ğŸ“¦ Departures æ›´æ–°ç›‘æ§")
  titleText.font = "headline"
  stack.add(titleText)

  const toggle = new Toggle()
  toggle.title = "å¼€å¯ç›‘æ§"
  toggle.value = enabled
  toggle.onChanged = v => { setEnabled(v); setStorage(ENABLE_KEY, v) }
  stack.add(toggle)

  const infoText = new Text("ç‚¹å‡»æ¡ç›®è·³è½¬ç½‘é¡µ")
  infoText.font = "footnote"
  stack.add(infoText)

  const displayCount = Math.min(items.length, MAX_DISPLAY)
  for (let i = 0; i < displayCount; i++) {
    const item = items[i]
    const link = new Link(item.link)
    const t = new Text("â€¢ " + item.title)
    t.font = "footnote"
    t.lineLimit = 1
    link.add(t)
    stack.add(link)
  }

  stack.add(new Spacer())

  const intervalText = new Text("åˆ·æ–°é—´éš”: " + interval + " åˆ†é’Ÿ")
  intervalText.font = "caption2"
  stack.add(intervalText)

  const slider = new Slider()
  slider.min = MIN_INTERVAL
  slider.max = 120
  slider.step = 5
  slider.value = interval
  slider.onChanged = v => { setInterval(v); setStorage(INTERVAL_KEY, v) }
  stack.add(slider)

  const refreshBtn = new Button()
  refreshBtn.title = "ç«‹å³åˆ·æ–°"
  refreshBtn.onTap = refresh
  stack.add(refreshBtn)

  return stack
}

// ---------------- Widget ----------------
async function mainWidget() {
  const items = await fetchDepartures()

  const stack = new VStack()
  stack.spacing = 8
  stack.padding = 16
  stack.alignment = "leading"

  const title = new Text("ğŸ“¦ Departures æ›´æ–°")
  title.font = "headline"
  stack.add(title)

  const displayCount = Math.min(items.length, MAX_DISPLAY)
  for (let i = 0; i < displayCount; i++) {
    const item = items[i]
    const t = new Text("â€¢ " + item.title)
    t.font = "footnote"
    t.lineLimit = 1
    stack.add(t)
  }

  stack.add(new Spacer())
  const updateTime = new Text("æ›´æ–°æ—¶é—´: " + new Date().toLocaleTimeString())
  updateTime.font = "caption2"
  stack.add(updateTime)

  return stack
}

// ---------------- è¿è¡Œ ----------------
async function run() {
  // å¦‚æœåœ¨å°ç»„ä»¶ç¯å¢ƒåˆ™æ˜¾ç¤º Widget
  if (globalThis.runsInWidget) {
    const el = await mainWidget()
    Widget.present(el)
  } else {
    // å¦åˆ™æ˜¾ç¤ºå¯äº¤äº’è„šæœ¬ç•Œé¢
    const el = View()
    await Navigation.present({ element: el })
  }
  Script.exit()
}

run()
