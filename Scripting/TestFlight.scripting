// Author: Reviewa
// TestFlight departures.to ç›‘æ§è„šæœ¬
// æ”¯æŒ Widget ç‚¹å‡»è·³è½¬ã€è‡ªåŠ¨åˆ·æ–°ã€é…ç½®é¡µé¢

// æ ¸å¿ƒå‡½æ•°
function get(key, defaultValue) {
  try {
    const value = localStorage.getItem(key)
    return value !== null ? JSON.parse(value) : defaultValue
  } catch {
    return defaultValue
  }
}

function set(key, value) {
  localStorage.setItem(key, JSON.stringify(value))
}

async function fetchHTML(url) {
  const response = await fetch(url)
  return await response.text()
}

async function autoRefresh(callback, key, intervalMin = 5) {
  const last = get(key, 0)
  const now = Date.now()
  if (now - last > intervalMin * 60 * 1000) {
    await callback()
    set(key, now)
  }
}

// Scripting App ç»„ä»¶
import { Navigation, List, Section, Toggle, Button, NavigationStack, Widget, Link, Text as WText, Stack, Spacer, Script } from "scripting"

function buildStack(items, titleText, maxDisplay = 5) {
  const stack = new Stack()
  stack.spacing = 8
  stack.padding = 16
  stack.add(new WText(titleText).font("headline"))

  for (let i = 0; i < Math.min(items.length, maxDisplay); i++) {
    const item = items[i]
    const link = new Link(item.link)
    const t = new WText("â€¢ " + item.title)
    t.font = "footnote"
    t.lineLimit = 1
    link.add(t)
    stack.add(link)
  }

  stack.add(new Spacer())
  return stack
}

function ConfigPage() {
  return (
    <NavigationStack>
      <List navigationTitle="Departures é…ç½®">
        <Section footer={<WText>è°ƒæ•´åˆ·æ–°é—´éš”å’Œæ˜¾ç¤ºæ¡ç›®æ•°</WText>}>
          <Toggle
            title="è‡ªåŠ¨åˆ·æ–°å¼€å…³"
            value={get("_autoRefresh_enabled", true)}
            onChanged={v => set("_autoRefresh_enabled", v)}
          />
        </Section>
        <Section>
          <Button title="å…³é—­" action={() => Navigation.dismiss()} />
        </Section>
      </List>
    </NavigationStack>
  )
}

// TestFlight ä¸šåŠ¡é€»è¾‘
const STORAGE_KEY = "_departures_lastTitle"
const REFRESH_KEY = "_autoRefresh_interval"
const DISPLAY_KEY = "_widget_maxDisplay"

async function fetchDepartures() {
  const html = await fetchHTML("https://departures.to/latest")
  const regex = /<h2[^>]*>.*?<a href="(.*?)".*?>(.*?)<\/a>.*?<\/h2>/g
  const items = []
  let match
  while ((match = regex.exec(html)) !== null) {
    const link = match[1].trim()
    const title = match[2].replace(/<[^>]+>/g, "").trim()
    if (title && link) items.push({ title, link })
  }
  return items
}

async function notifyNew(items) {
  if (!items.length) return
  const lastTitle = get(STORAGE_KEY, "")
  if (items[0].title !== lastTitle) {
    await Widget.notify("Departures æ–°æ¡ç›®", items[0].title)
    set(STORAGE_KEY, items[0].title)
  }
}

function buildStackWithLinks(items, titleText) {
  const maxDisplay = get(DISPLAY_KEY, 5)
  const stack = new Stack()
  stack.spacing = 8
  stack.padding = 16
  stack.add(new WText(titleText).font("headline"))

  for (let i = 0; i < Math.min(items.length, maxDisplay); i++) {
    const item = items[i]
    const link = new Link(item.link)
    const t = new WText("â€¢ " + item.title)
    t.font = "footnote"
    t.lineLimit = 1
    link.add(t)
    stack.add(link)
  }

  stack.add(new Spacer())
  return stack
}

async function main() {
  await autoRefresh(async () => {
    const items = await fetchDepartures()
    await notifyNew(items)
  }, REFRESH_KEY)

  const items = await fetchDepartures()

  if (Script.parameter === "config") {
    await Navigation.present({ element: ConfigPage() })
  } else if (globalThis.runsInWidget) {
    const stack = buildStackWithLinks(items, "ğŸ“¦ Departures æ›´æ–°")
    Widget.present(stack)
  } else {
    const stack = buildStackWithLinks(items, "ğŸ“¦ Departures æ›´æ–°")
    await Navigation.present({ element: stack })
  }

  Script.exit()
}

main()